# Cloud Hypervisor é¡¹ç›®åˆ†æ

## é¡¹ç›®æ¦‚è§ˆ

| é¡¹ç›® | ä¿¡æ¯ |
|------|------|
| **åç§°** | Cloud Hypervisor |
| **ç±»å‹** | è™šæ‹Ÿæœºç›‘è§†å™¨ (VMM) |
| **è¯­è¨€** | Rust (Edition 2024) |
| **è®¸å¯è¯** | Apache-2.0 / BSD-3-Clause |
| **ä»“åº“** | https://github.com/cloud-hypervisor/cloud-hypervisor |

### é¡¹ç›®å®šä½

Cloud Hypervisor æ˜¯ä¸€ä¸ªå¼€æºçš„è™šæ‹Ÿæœºç›‘è§†å™¨ (VMM)ï¼Œè¿è¡Œåœ¨ KVM å’Œ Microsoft Hypervisor (MSHV) ä¹‹ä¸Šã€‚

### è®¾è®¡ç›®æ ‡

- **é«˜æ€§èƒ½**: ä½å»¶è¿Ÿã€é«˜ååé‡
- **ä½èµ„æºå ç”¨**: æœ€å°å†…å­˜å ç”¨ã€å°æ”»å‡»é¢
- **ç°ä»£æ¶æ„**: ä»…æ”¯æŒ 64 ä½ï¼Œæ— ä¼ ç»Ÿè®¾å¤‡ä¾èµ–
- **äº‘åŸç”Ÿ**: é’ˆå¯¹äº‘å·¥ä½œè´Ÿè½½ä¼˜åŒ–

### æ”¯æŒçš„æ¶æ„

| æ¶æ„ | çŠ¶æ€ |
|------|------|
| x86-64 | âœ… å®Œå…¨æ”¯æŒ |
| AArch64 | âœ… å®Œå…¨æ”¯æŒ |
| riscv64 | âš ï¸ å®éªŒæ€§æ”¯æŒ |

### æ”¯æŒçš„å®¢æˆ·æœº

- 64-bit Linux
- Windows 10 / Windows Server 2019+

---

## ç›®å½•ç»“æ„

```
cloud-hypervisor/
â”œâ”€â”€ src/                    # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ vmm/                    # VMM æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ arch/                   # æ¶æ„ç›¸å…³ä»£ç 
â”‚   â”œâ”€â”€ x86_64/
â”‚   â”œâ”€â”€ aarch64/
â”‚   â””â”€â”€ riscv64/
â”œâ”€â”€ hypervisor/             # Hypervisor æŠ½è±¡å±‚
â”‚   â”œâ”€â”€ kvm/               # KVM åç«¯
â”‚   â””â”€â”€ mshv/              # Microsoft Hypervisor åç«¯
â”œâ”€â”€ virtio-devices/         # VirtIO è®¾å¤‡å®ç°
â”œâ”€â”€ devices/                # å¹³å°è®¾å¤‡
â”œâ”€â”€ pci/                    # PCI æ€»çº¿å®ç°
â”œâ”€â”€ block/                  # å—è®¾å¤‡åç«¯
â”œâ”€â”€ net_util/               # ç½‘ç»œå·¥å…·
â”œâ”€â”€ vm-allocator/           # èµ„æºåˆ†é…å™¨
â”œâ”€â”€ vm-device/              # è®¾å¤‡æŠ½è±¡
â”œâ”€â”€ vm-migration/           # è¿ç§»æ”¯æŒ
â”œâ”€â”€ vm-virtio/              # VirtIO é˜Ÿåˆ—
â”œâ”€â”€ api_client/             # HTTP API å®¢æˆ·ç«¯
â”œâ”€â”€ vhost_user_block/       # vhost-user å—è®¾å¤‡
â”œâ”€â”€ vhost_user_net/         # vhost-user ç½‘ç»œè®¾å¤‡
â””â”€â”€ docs/                   # æ–‡æ¡£
```

---

## æ ¸å¿ƒæ¨¡å—

### 1. VMM æ ¸å¿ƒ (`vmm/`)

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `vm.rs` | VM ç”Ÿå‘½å‘¨æœŸç®¡ç† |
| `cpu.rs` | vCPU ç®¡ç† |
| `memory_manager.rs` | Guest å†…å­˜ç®¡ç† |
| `device_manager.rs` | è®¾å¤‡ç®¡ç† |
| `interrupt.rs` | ä¸­æ–­è·¯ç”± |
| `config.rs` | é…ç½®è§£æ |
| `api/` | HTTP API æœåŠ¡å™¨ |

### 2. æ¶æ„å±‚ (`arch/`)

| ç›®å½• | æ¶æ„ | ç‰¹å®šåŠŸèƒ½ |
|------|------|----------|
| `x86_64/` | Intel/AMD | MTRR, MSRs, PMU, CPUID |
| `aarch64/` | ARM64 | GIC ä¸­æ–­æ§åˆ¶å™¨ |
| `riscv64/` | RISC-V | AIA ä¸­æ–­æ§åˆ¶å™¨ |

### 3. Hypervisor æŠ½è±¡ (`hypervisor/`)

```rust
// æ ¸å¿ƒæŠ½è±¡
pub trait Hypervisor: Send + Sync { ... }
pub trait Vm: Send + Sync { ... }
pub trait Vcpu: Send + Sync { ... }
pub trait Device: Send + Sync { ... }

// åç«¯å®ç°
mod kvm;  // Linux KVM
mod mshv; // Microsoft Hypervisor
```

### 4. è®¾å¤‡æ¨¡å‹ (`devices/`)

| è®¾å¤‡ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| ä¸­æ–­æ§åˆ¶å™¨ | `interrupt_controller.rs` | ä¸­æ–­æ§åˆ¶å™¨æŠ½è±¡ |
| GIC | `gic.rs` | ARM GIC å®ç° |
| IOAPIC | `ioapic.rs` | x86 IOAPIC |
| AIA | `aia.rs` | RISC-V AIA |
| ACPI | `acpi.rs` | ACPI è¡¨ç”Ÿæˆ |
| IVSHMEM | `ivshmem.rs` | å…±äº«å†…å­˜è®¾å¤‡ |
| TPM | `tpm.rs` | TPM è®¾å¤‡ |
| PVPanic | `pvpanic.rs` | Panic é€šçŸ¥ |

---

## VirtIO è®¾å¤‡

### è®¾å¤‡åˆ—è¡¨ (`virtio-devices/`)

| è®¾å¤‡ | æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|------|
| Block | `block.rs` | å—å­˜å‚¨è®¾å¤‡ |
| Net | `net.rs` | ç½‘ç»œè®¾å¤‡ |
| Console | `console.rs` | æ§åˆ¶å° |
| Balloon | `balloon.rs` | å†…å­˜æ°”çƒ |
| RNG | `rng.rs` | éšæœºæ•°ç”Ÿæˆå™¨ |
| PMEM | `pmem.rs` | æŒä¹…å†…å­˜ |
| MEM | `mem.rs` | å†…å­˜è®¾å¤‡ |
| IOMMU | `iommu.rs` | IOMMU è®¾å¤‡ |
| Vsock | `vsock/` | VSocket |
| Watchdog | `watchdog.rs` | çœ‹é—¨ç‹— |
| VDPA | `vdpa.rs` | vDPA æ”¯æŒ |

### VirtIO Transport (`virtio-devices/transport/`)

- **PCI**: VirtIO over PCI (ä¸»è¦æ–¹å¼)
- **MMIO**: VirtIO over MMIO (åµŒå…¥å¼åœºæ™¯)

### Vhost-user æ”¯æŒ (`virtio-devices/vhost_user/`)

- Block: vhost-user-blk
- Net: vhost-user-net
- FS: virtio-fs

---

## å—è®¾å¤‡åç«¯ (`block/`)

### æ”¯æŒçš„æ ¼å¼

| æ ¼å¼ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| Raw | `raw_sync.rs`, `raw_async.rs` | åŸå§‹é•œåƒ |
| QCOW2 | `qcow/`, `qcow_sync.rs` | QEMU QCOW2 |
| VHD | `fixed_vhd*.rs` | å›ºå®š VHD |
| VHDX | `vhdx/`, `vhdx_sync.rs` | VHDX æ ¼å¼ |

### IO æ¨¡å¼

- **åŒæ­¥**: ç›´æ¥é˜»å¡ IO
- **å¼‚æ­¥**: åŸºäº io_uring / AIO

---

## PCI å­ç³»ç»Ÿ (`pci/`)

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `bus.rs` | PCI æ€»çº¿æšä¸¾ |
| `configuration.rs` | PCI é…ç½®ç©ºé—´ |
| `device.rs` | PCI è®¾å¤‡æŠ½è±¡ |
| `msi.rs` | MSI ä¸­æ–­ |
| `msix.rs` | MSI-X ä¸­æ–­ |
| `vfio.rs` | VFIO ç›´é€š |
| `vfio_user.rs` | vfio-user åè®® |

---

## æ ¸å¿ƒä¾èµ–

### rust-vmm ç”Ÿæ€

| Crate | ç‰ˆæœ¬ | ç”¨é€” |
|-------|------|------|
| `kvm-bindings` | 0.12.1 | KVM ç»“æ„ä½“ç»‘å®š |
| `kvm-ioctls` | 0.22.1 | KVM ioctl å°è£… |
| `mshv-bindings` | 0.6.7 | MSHV ç»‘å®š |
| `mshv-ioctls` | 0.6.7 | MSHV ioctl |
| `vm-memory` | 0.16.1 | Guest å†…å­˜æŠ½è±¡ |
| `virtio-queue` | 0.16.0 | VirtIO é˜Ÿåˆ— |
| `virtio-bindings` | 0.2.6 | VirtIO ç»“æ„ä½“ |
| `vhost` | 0.14.0 | vhost åè®® |
| `vhost-user-backend` | 0.20.0 | vhost-user åç«¯ |
| `vfio-bindings` | 0.6.0 | VFIO ç»‘å®š |
| `vfio-ioctls` | 0.5.1 | VFIO ioctl |
| `seccompiler` | 0.5.0 | seccomp è¿‡æ»¤å™¨ |
| `linux-loader` | 0.13.1 | å†…æ ¸åŠ è½½å™¨ |
| `acpi_tables` | 0.2.0 | ACPI è¡¨ |

### IGVM æ”¯æŒ

| Crate | ç‰ˆæœ¬ | ç”¨é€” |
|-------|------|------|
| `igvm` | 0.4.0 | IGVM æ ¼å¼æ”¯æŒ |
| `igvm_defs` | 0.4.0 | IGVM å®šä¹‰ |

---

## API è®¾è®¡

### HTTP API (`vmm/src/api/`)

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/vmm.ping` | GET | å¥åº·æ£€æŸ¥ |
| `/vmm.shutdown` | PUT | å…³é—­ VMM |
| `/vm.info` | GET | VM ä¿¡æ¯ |
| `/vm.counters` | GET | æ€§èƒ½è®¡æ•°å™¨ |
| `/vm.add-device` | PUT | çƒ­æ’è®¾å¤‡ |
| `/vm.remove-device` | PUT | çƒ­æ‹”è®¾å¤‡ |
| `/vm.resize` | PUT | è°ƒæ•´èµ„æº |
| `/vm.create-snapshot` | PUT | åˆ›å»ºå¿«ç…§ |
| `/vm.restore` | PUT | æ¢å¤å¿«ç…§ |
| `/vm.migrate` | PUT | è¿ç§» |

### CLI æ¥å£

```bash
cloud-hypervisor \
  --kernel <path> \           # å†…æ ¸é•œåƒ
  --firmware <path> \         # å›ºä»¶
  --disk path=<path> \        # ç£ç›˜é•œåƒ
  --cpus boot=<n> \           # CPU æ•°é‡
  --memory size=<size> \      # å†…å­˜å¤§å°
  --net tap=<tap>,mac=<mac> \ # ç½‘ç»œé…ç½®
  --serial <mode> \           # ä¸²å£æ¨¡å¼
  --console <mode>            # æ§åˆ¶å°æ¨¡å¼
```

---

## é«˜çº§ç‰¹æ€§

### çƒ­æ’æ‹”æ”¯æŒ

- CPU çƒ­æ’
- å†…å­˜çƒ­æ’
- VFIO è®¾å¤‡çƒ­æ’
- virtio-{net,block,pmem,fs,vsock} çƒ­æ’

### å¿«ç…§ä¸è¿ç§»

- å¿«ç…§åˆ›å»º/æ¢å¤
- è·¨ä¸»æœºè¿ç§»
- çŠ¶æ€åºåˆ—åŒ–

### å®‰å…¨ç‰¹æ€§

- **TDX**: Intel Trust Domain Extensions
- **SEV-SNP**: AMD Secure Encrypted Virtualization
- **Seccomp**: ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤
- **Landlock**: Linux å®‰å…¨æ¨¡å—

### æ€§èƒ½ä¼˜åŒ–

- **io_uring**: å¼‚æ­¥ IO
- **vhost**: å†…æ ¸æ€åŠ é€Ÿ
- **vDPA**: vhost æ•°æ®è·¯å¾„åŠ é€Ÿ

---

## è®¾è®¡æ¨¡å¼

### Vmm æ ¸å¿ƒç»“æ„

```rust
pub struct Vmm {
    config: VmConfig,
    vm: Arc<dyn HypervisorVm>,
    vcpus: Vec<Arc<dyn Vcpu>>,
    memory_manager: Arc<MemoryManager>,
    device_manager: Arc<DeviceManager>,
    // ...
}
```

### è®¾å¤‡æŠ½è±¡

```rust
pub trait Device: Send + Sync {
    fn device_type(&self) -> DeviceType;
    fn reset(&mut self);
}
```

### VirtIO è®¾å¤‡ Trait

```rust
pub trait VirtioDevice: Send {
    fn device_type(&self) -> u32;
    fn queue_max_sizes(&self) -> &[u16];
    fn features(&self) -> u64;
    fn activate(&mut self, ...);
}
```

---

## æ„å»ºä¸è¿è¡Œ

### æ„å»º

```bash
cargo build --release
```

### è¿è¡Œç¤ºä¾‹

```bash
# ç›´æ¥å†…æ ¸å¯åŠ¨
./cloud-hypervisor \
  --kernel ./vmlinux \
  --disk path=disk.raw \
  --cpus boot=4 \
  --memory size=4G \
  --net tap=tap0

# å›ºä»¶å¯åŠ¨
./cloud-hypervisor \
  --firmware ./hypervisor-fw \
  --disk path=cloud-image.raw \
  --cpus boot=4 \
  --memory size=4G
```

---

## ä¸å…¶ä»–é¡¹ç›®çš„å…³ç³»

### vs Firecracker

| ç‰¹æ€§ | Cloud Hypervisor | Firecracker |
|------|------------------|-------------|
| ç›®æ ‡åœºæ™¯ | é€šç”¨äº‘å·¥ä½œè´Ÿè½½ | Serverless/å®¹å™¨ |
| çƒ­æ’æ‹” | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| è¿ç§» | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| æ¶æ„ | x86, ARM, RISC-V | x86, ARM |

### vs crosvm

| ç‰¹æ€§ | Cloud Hypervisor | crosvm |
|------|------------------|--------|
| ç›®æ ‡åœºæ™¯ | äº‘å·¥ä½œè´Ÿè½½ | Chrome OS |
| Hypervisor | KVM, MSHV | KVM |
| ä»£ç å¤ç”¨ | rust-vmm | rust-vmm |

---

## æ–‡æ¡£èµ„æº

- [API æ–‡æ¡£](https://github.com/cloud-hypervisor/cloud-hypervisor/blob/main/docs/api.md)
- [è®¾å¤‡æ¨¡å‹](https://github.com/cloud-hypervisor/cloud-hypervisor/blob/main/docs/device_model.md)
- [å†…å­˜ç®¡ç†](https://github.com/cloud-hypervisor/cloud-hypervisor/blob/main/docs/memory.md)
- [çƒ­æ’æ‹”](https://github.com/cloud-hypervisor/cloud-hypervisor/blob/main/docs/hotplug.md)
- [å®æ—¶è¿ç§»](https://github.com/cloud-hypervisor/cloud-hypervisor/blob/main/docs/live_migration.md)
- [å¿«ç…§æ¢å¤](https://github.com/cloud-hypervisor/cloud-hypervisor/blob/main/docs/snapshot_restore.md)

---

## æ€»ç»“

Cloud Hypervisor æ˜¯ä¸€ä¸ªç°ä»£ã€é«˜æ€§èƒ½ã€å®‰å…¨çš„ VMM å®ç°ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **çº¯ Rust å®ç°**: åˆ©ç”¨ Rust çš„å†…å­˜å®‰å…¨ç‰¹æ€§
2. **æ¨¡å—åŒ–è®¾è®¡**: åŸºäº rust-vmm ç”Ÿæ€æ„å»º
3. **å¤šæ¶æ„æ”¯æŒ**: x86-64, AArch64, RISC-V
4. **å¤š Hypervisor**: KVM å’Œ MSHV åç«¯
5. **ä¸°å¯Œçš„è®¾å¤‡æ¨¡å‹**: VirtIO è®¾å¤‡ + å¹³å°è®¾å¤‡
6. **ä¼ä¸šçº§ç‰¹æ€§**: çƒ­æ’æ‹”ã€è¿ç§»ã€å¿«ç…§
7. **å®‰å…¨å¢å¼º**: TDX, SEV-SNP, seccomp æ”¯æŒ

é€‚åˆä½œä¸ºå­¦ä¹ ç°ä»£ VMM å®ç°çš„å‚è€ƒé¡¹ç›®ã€‚

---

## lg-capture é›†æˆæ–¹æ¡ˆåˆ†æ

æœ¬ç« èŠ‚åˆ†æå¦‚ä½•åœ¨ Cloud Hypervisor ä¸­é›†æˆ lg-capture åŠŸèƒ½ï¼ˆå¸§æ•è·ã€å…‰æ ‡ã€éŸ³é¢‘ã€é”®é¼ è¾“å…¥ï¼‰ã€‚

### ç°æœ‰æ”¯æŒæƒ…å†µ

| lg-capture åŠŸèƒ½ | Cloud Hypervisor çŠ¶æ€ | è¯´æ˜ |
|----------------|----------------------|------|
| **å…±äº«å†…å­˜** | âœ… `ivshmem.rs` å·²å­˜åœ¨ | IVSHMEM è®¾å¤‡æ”¯æŒ |
| **VFIO é€ä¼ ** | âœ… `pci/vfio.rs` æ”¯æŒ | GPU ç›´é€šå¯è¡Œ |
| **çƒ­æ’æ‹”** | âœ… æ”¯æŒ | åŠ¨æ€æ·»åŠ è®¾å¤‡ |
| **HTTP API** | âœ… `/vm.add-device` | å¯ç¼–ç¨‹æ§åˆ¶ |
| **virtio-gpu** | âŒ æœªå®ç° | éœ€è¦æ–°å¢ |
| **virtio-snd** | âŒ æœªå®ç° | éœ€è¦æ–°å¢ |
| **virtio-input** | âŒ æœªå®ç° | éœ€è¦æ–°å¢ |
| **i8042 é”®ç›˜** | âš ï¸ æç®€åŒ– | ä»…æ”¯æŒ resetï¼Œä¸æ”¯æŒè¾“å…¥æ³¨å…¥ |

### ç¼ºå¤±ç»„ä»¶

| åŠŸèƒ½ | çŠ¶æ€ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **virtio-gpu** | âŒ æœªå®ç° | éœ€è¦æ–°å¢ VirtIO è®¾å¤‡ |
| **virtio-snd** | âŒ æœªå®ç° | éŸ³é¢‘éœ€è¦æ–°è®¾å¤‡ |
| **virtio-input** | âŒ æœªå®ç° | é”®é¼ è¾“å…¥éœ€è¦æ–°è®¾å¤‡ |
| **å¸§æ•è·æ¥å£** | âŒ æ—  | éœ€è¦è®¾è®¡æ–°æ¥å£ |

---

### GPU è™šæ‹ŸåŒ–æ–¹æ¡ˆå¯¹æ¯”

Cloud Hypervisor æ”¯æŒå¤šç§ GPU è™šæ‹ŸåŒ–æ–¹å¼ï¼Œä¸åŒæ–¹å¼å¯¹ lg-capture çš„å¸§æ•è·æœ‰ä¸åŒçš„å½±å“ã€‚

#### æ–¹æ¡ˆ A: virtio-gpu (è½¯ä»¶æ¨¡æ‹Ÿ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Host GPU                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Host é©±åŠ¨                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                              â”‚
â”‚                       â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ virtio-gpu (è½¯ä»¶æ¨¡æ‹Ÿ)                         â”‚  â”‚
â”‚  â”‚ - VMM æ‹¦æˆª GPU æŒ‡ä»¤                           â”‚  â”‚
â”‚  â”‚ - å¯ç›´æ¥æ•è·å¸§æ•°æ®                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                              â”‚
â”‚                       â–¼                              â”‚
â”‚              Guest çœ‹åˆ°è™šæ‹Ÿ GPU                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹: å¤š VM å…±äº«ã€å¯æ•è·å¸§ã€å®ç°ç®€å•
ç¼ºç‚¹: æ€§èƒ½æŸå¤±ã€ä¸é€‚åˆ 3D é«˜è´Ÿè½½
```

#### æ–¹æ¡ˆ B: GPU ç›´é€š (VFIO)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‰©ç† GPU                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç›´é€šç»™ VM                                     â”‚  â”‚
â”‚  â”‚ - Host æ— æ³•ä½¿ç”¨                               â”‚  â”‚
â”‚  â”‚ - Guest ç›´æ¥æ§åˆ¶                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                              â”‚
â”‚                       â–¼                              â”‚
â”‚              Guest åŸç”Ÿ GPU é©±åŠ¨                      â”‚
â”‚              (éœ€è¦ Guest Agent æ•è·å¸§)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹: æ¥è¿‘åŸç”Ÿæ€§èƒ½
ç¼ºç‚¹: ç‹¬å  GPUã€æ— æ³•ä» VMM æ•è·å¸§
```

#### æ–¹æ¡ˆ C: SR-IOV / vGPU (ç¡¬ä»¶è™šæ‹ŸåŒ–)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‰©ç† GPU (æ”¯æŒ SR-IOV)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ PF (Physical Function) - Host ç®¡ç†            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚         â–¼               â–¼               â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ VF0 (VM1) â”‚   â”‚ VF1 (VM2) â”‚   â”‚ VF2 (VM3) â”‚    â”‚
â”‚  â”‚ ç‹¬ç«‹ vGPU â”‚   â”‚ ç‹¬ç«‹ vGPU â”‚   â”‚ ç‹¬ç«‹ vGPU â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚

æ”¯æŒ SR-IOV çš„ GPU:
- Intel Arc (éƒ¨åˆ†å‹å·)
- NVIDIA A100/H100 (vGPU è®¸å¯)
- AMD Instinct (éƒ¨åˆ†å‹å·)

ä¼˜ç‚¹: å¤š VM å…±äº« + é«˜æ€§èƒ½
ç¼ºç‚¹: éœ€è¦ç‰¹å®šç¡¬ä»¶ã€éœ€è¦ vGPU è®¸å¯
```

#### æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| æ–¹é¢ | virtio-gpu | GPU ç›´é€š | SR-IOV / vGPU |
|------|------------|----------|---------------|
| **æ€§èƒ½** | ä½-ä¸­ | æ¥è¿‘åŸç”Ÿ | é«˜ |
| **å¤š VM å…±äº«** | âœ… | âŒ | âœ… |
| **å¸§æ•è·** | âœ… VMM æ‹¦æˆª | âš ï¸ éœ€è¦ Agent | âš ï¸ éœ€è¦ Agent |
| **ç¡¬ä»¶è¦æ±‚** | æ—  | ç‹¬ç«‹ GPU | SR-IOV GPU |
| **å®ç°å¤æ‚åº¦** | ä¸­ | ä½ | ä¸­ |

---

### å¸§æ•è·æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: virtio-gpu (æ— éœ€ Guest Agent)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Cloud Hypervisor                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                virtio-gpu                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Frame Buffer Capture                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - æ‹¦æˆª GPU æŒ‡ä»¤                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - æå–å¸§æ•°æ®                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - æå–å…‰æ ‡æ•°æ®                           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                             â”‚
â”‚                         â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              IVSHMEM å…±äº«å†…å­˜                   â”‚  â”‚
â”‚  â”‚  [å¸§1][å¸§2][å¸§3][å…‰æ ‡][éŸ³é¢‘]                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  lg-capture     â”‚
                â”‚  (Host è¯»å–)    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ–¹æ¡ˆ 2: GPU ç›´é€š + Guest Agent

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Cloud Hypervisor                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    VM (Guest)                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚              ç‰©ç†GPU (VFIO ç›´é€š)                    â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                       â”‚                                  â”‚ â”‚
â”‚  â”‚                       â–¼                                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚         lg-capture Guest Agent                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Windows: Desktop Duplication API                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Linux:   DRM/KMS API æˆ– /dev/fb0                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â†’ æ•è·å¸§ â†’ å†™å…¥ IVSHMEM                           â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                â”‚
â”‚                        IVSHMEM                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   lg-capture Host   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Windows Guest Agent å®ç° (Desktop Duplication API):**

```cpp
// ä½¿ç”¨ IDXGIOutputDuplication æ•è·æ¡Œé¢
IDXGIOutputDuplication* pDuplication;
pOutput->DuplicateOutput(pDevice, &pDuplication);

// è·å–ä¸‹ä¸€å¸§
IDXGIResource* pDesktopResource;
pDuplication->AcquireNextFrame(timeout, &frameInfo, &pDesktopResource);

// è·å–å¸§æ•°æ®
pDesktopResource->QueryInterface(__uuidof(ID3D11Texture2D), &pAcquiredDesktopImage);

// å†™å…¥å…±äº«å†…å­˜ (IVSHMEM)
memcpy(pSharedMemory, pTextureData, frameSize);
```

**Linux Guest Agent å®ç° (DRM/KMS):**

```c
// ä½¿ç”¨ DRM API è·å–å¸§ç¼“å†²
int drm_fd = open("/dev/dri/card0", O_RDWR);
struct drm_mode_fb_cmd fb_cmd = { .fb_id = fb_id };
ioctl(drm_fd, DRM_IOCTL_MODE_GETFB, &fb_cmd);

// æˆ–è€…ç›´æ¥è¯»å– /dev/fb0
int fb_fd = open("/dev/fb0", O_RDONLY);
read(fb_fd, framebuffer, size);

// å†™å…¥ IVSHMEM
memcpy(pSharedMemory, framebuffer, size);
```

---

### é”®é¼ è¾“å…¥æ–¹æ¡ˆ

Cloud Hypervisor ç›®å‰ä¸æ”¯æŒ virtio-inputï¼Œéœ€è¦æ–°å¢ã€‚

#### æ–¹æ¡ˆ 1: æ–°å¢ virtio-input (æ¨è)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Cloud Hypervisor                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    PCI Bus                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚              virtio-input                        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  InputEvent Queue (VirtQueue)              â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - é”®ç›˜äº‹ä»¶: EV_KEY                        â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - é¼ æ ‡äº‹ä»¶: EV_REL (ç›¸å¯¹) / EV_ABS (ç»å¯¹) â”‚  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚  HTTP API: POST /vm.inject-input                             â”‚
â”‚  { "keyboard": [...], "mouse": [...] }                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    virtio åè®® (æ ‡å‡†)
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Guest é©±åŠ¨         â”‚
                    â”‚  Linux: evdev       â”‚
                    â”‚  Windows: virtio-winâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**virtio-input å®ç°ç¤ºä¾‹:**

```rust
// virtio-devices/src/input.rs

const VIRTIO_ID_INPUT: u32 = 18;

#[repr(C)]
#[derive(Clone, Copy)]
pub struct InputEvent {
    pub type_: u16,   // EV_KEY, EV_REL, EV_ABS
    pub code: u16,    // KEY_A, BTN_LEFT, REL_X
    pub value: i32,   // 0=release, 1=press, 2=repeat
}

pub struct InputDevice {
    device_type: u32,
    queues: Vec<Queue>,
    event_queue: VecDeque<InputEvent>,
    api_receiver: Receiver<InputRequest>,
}

impl VirtioDevice for InputDevice {
    fn device_type(&self) -> u32 { VIRTIO_ID_INPUT }
    // ... VirtIO æ ‡å‡†å®ç°
}
```

#### æ–¹æ¡ˆ 2: USB HID æ¨¡æ‹Ÿ (xHCI)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cloud Hypervisor                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    xHCI æ§åˆ¶å™¨ (éœ€æ–°å¢)                  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  USB è®¾å¤‡æ¨¡æ‹Ÿ                                       â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ HID Keyboard  â”‚  â”‚ HID Mouse     â”‚              â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ (è®¾å¤‡æè¿°ç¬¦)  â”‚  â”‚ (è®¾å¤‡æè¿°ç¬¦)  â”‚              â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚ Reportæ ¼å¼   â”‚  â”‚ Reportæ ¼å¼    â”‚              â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹: Windows åŸç”Ÿæ”¯æŒæ— éœ€é©±åŠ¨ã€æ”¯æŒä»»æ„ HID è®¾å¤‡ã€æ ‡å‡†åŒ–ç¨‹åº¦æœ€é«˜
ç¼ºç‚¹: å®ç°å¤æ‚ã€Cloud Hypervisor ç›®å‰æ²¡æœ‰ xHCI è®¾å¤‡æ¨¡æ‹Ÿ
```

#### æ–¹æ¡ˆ 3: i8042 + PS/2 é¼ æ ‡ (ä¼ ç»Ÿæ–¹æ¡ˆï¼Œä¸æ¨è)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Cloud Hypervisor                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Extended I8042                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚  â”‚  â”‚ é”®ç›˜ç¼“å†²åŒº   â”‚  â”‚ é¼ æ ‡ç¼“å†²åŒº    â”‚            â”‚  â”‚
â”‚  â”‚  â”‚ (æ‰«æç é˜Ÿåˆ—) â”‚  â”‚ (PS/2 åè®®)  â”‚            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹: å»¶è¿Ÿæœ€ä½ã€ä»»ä½• OS åŸç”Ÿæ”¯æŒ
ç¼ºç‚¹: ä»…æ”¯æŒé”®é¼ æ— æ³•æ‰©å±•ã€PS/2 åè®®å¤è€åŠŸèƒ½æœ‰é™ã€æ— æ³•æ”¯æŒç»å¯¹åæ ‡
é€‚ç”¨: æè‡´ä½å»¶è¿Ÿåœºæ™¯ã€è€æ—§ OS å…¼å®¹
```

---

### å®Œæ•´é›†æˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Cloud Hypervisor                           â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        PCI Bus                               â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚virtio-gpuâ”‚ â”‚virtio-sndâ”‚ â”‚virtio-   â”‚ â”‚    IVSHMEM     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ (æ–°å¢)   â”‚ â”‚ (æ–°å¢)   â”‚ â”‚ input    â”‚ â”‚    (ç°æœ‰)      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚          â”‚ â”‚          â”‚ â”‚ (æ–°å¢)   â”‚ â”‚                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ å¸§è¾“å‡º   â”‚ â”‚ éŸ³é¢‘è¾“å‡º â”‚ â”‚ é”®é¼ è¾“å…¥ â”‚ â”‚ é…ç½®/çŠ¶æ€å…±äº«  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚       â”‚            â”‚            â”‚               â”‚           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚            â”‚            â”‚               â”‚             â”‚
â”‚          â–¼            â–¼            â–¼               â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 lg-capture Bridge (å¯é€‰)                   â”‚  â”‚
â”‚  â”‚  - æ”¶é›† virtio-gpu å¸§æ•°æ® â†’ å†™å…¥ IVSHMEM                  â”‚  â”‚
â”‚  â”‚  - æ”¶é›† virtio-snd éŸ³é¢‘ â†’ å†™å…¥ IVSHMEM                    â”‚  â”‚
â”‚  â”‚  - ä» IVSHMEM è¯»å–è¾“å…¥äº‹ä»¶ â†’ æ³¨å…¥ virtio-input            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                      å…±äº«å†…å­˜ / virtio åè®®
                                â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   lg-capture Host   â”‚                   â”‚   Guest (VM)        â”‚
â”‚   - è¯»å–å¸§/å…‰æ ‡/éŸ³é¢‘ â”‚                   â”‚   - GPU é©±åŠ¨        â”‚
â”‚   - å†™å…¥é”®é¼ äº‹ä»¶    â”‚                   â”‚   - Audio é©±åŠ¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   - Input é©±åŠ¨      â”‚
                                          â”‚   - æˆ– Guest Agent  â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å·¥ä½œé‡è¯„ä¼°

| æ¨¡å— | å·¥ä½œé‡ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|--------|------|
| **virtio-gpu** | 2-3å‘¨ | ğŸ”´ é«˜ | å‚è€ƒ crosvm/rutabaga_gfx |
| **virtio-snd** | 1å‘¨ | ğŸŸ¡ ä¸­ | åŸºç¡€éŸ³é¢‘æ”¯æŒ |
| **virtio-input** | 1-2å‘¨ | ğŸ”´ é«˜ | VirtIO æ ‡å‡†å®ç° |
| **IVSHMEM å¤šç¼“å†²æ‰©å±•** | 3å¤© | ğŸ”´ é«˜ | æ‰©å±•ç°æœ‰å®ç° |
| **lg-capture Bridge** | 1-2å‘¨ | ğŸŸ¡ ä¸­ | VMM å†…éƒ¨æ¡¥æ¥ |
| **Windows Guest Agent** | 2-3å‘¨ | ğŸŸ¡ ä¸­ | Desktop Duplication |
| **Linux Guest Agent** | 1å‘¨ | ğŸŸ¢ ä½ | DRM/KMS å®ç° |

**æ€»è®¡**: 8-12 å‘¨

---

### åœºæ™¯å†³ç­–æ ‘

```
ä½ çš„éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Ÿ
       â”‚
       â”œâ”€â”€ å¤š VM å…±äº« GPU
       â”‚       â”‚
       â”‚       â”œâ”€â”€ éœ€è¦é«˜æ€§èƒ½ â†’ SR-IOV / vGPU (éœ€è¦ä¸“ä¸šå¡)
       â”‚       â”‚
       â”‚       â””â”€â”€ æ€§èƒ½è¦æ±‚ä¸é«˜ â†’ virtio-gpu + virgl
       â”‚
       â””â”€â”€ å• VM ç‹¬å  GPU (é«˜æ€§èƒ½éœ€æ±‚)
               â”‚
               â”œâ”€â”€ éœ€è¦å¸§æ•è·
               â”‚       â”‚
               â”‚       â”œâ”€â”€ Windows Guest
               â”‚       â”‚       â†’ Guest Agent (Desktop Duplication API)
               â”‚       â”‚
               â”‚       â””â”€â”€ Linux Guest
               â”‚               â†’ Guest Agent (DRM/KMS)
               â”‚
               â””â”€â”€ ä¸éœ€è¦å¸§æ•è·
                       â†’ çº¯ VFIO ç›´é€š
```

---

### ä¸ LXC å®¹å™¨çš„å…³ç³»

Cloud Hypervisor **ä¸æ”¯æŒ LXC å®¹å™¨**ï¼Œå®ƒä»¬æ˜¯ä¸åŒå±‚æ¬¡çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼š

| æŠ€æœ¯ | ç±»å‹ | éš”ç¦»çº§åˆ« |
|------|------|----------|
| Cloud Hypervisor | VMM (ç¡¬ä»¶è™šæ‹ŸåŒ–) | å¼ºéš”ç¦» (ç‹¬ç«‹å†…æ ¸) |
| LXC | å®¹å™¨ (OS è™šæ‹ŸåŒ–) | å¼±éš”ç¦» (å…±äº«å†…æ ¸) |

**ç»„åˆä½¿ç”¨æ–¹å¼**: åœ¨ Cloud Hypervisor åˆ›å»ºçš„ VM å†…éƒ¨å¯ä»¥è¿è¡Œ LXC å®¹å™¨ã€‚

---

### å‚è€ƒèµ„æº

- [VirtIO è§„èŒƒ](https://docs.oasis-open.org/virtio/virtio/v1.1/csprd01/virtio-v1.1-csprd01.html)
- [virtio-gpu è§„èŒƒ](https://www.kraxel.org/virtio/)
- [virtio-input è§„èŒƒ](https://www.linux.org/threads/virtio-input-device.13770/)
- [NVIDIA vGPU](https://www.nvidia.com/en-us/data-center/virtualization/)
- [Intel SR-IOV](https://www.intel.com/content/www/us/en/developer/articles/technical/introduction-to-sr-iov.html)
